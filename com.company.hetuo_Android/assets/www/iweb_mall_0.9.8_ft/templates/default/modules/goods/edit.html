<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>{echo: lp{m_u_center};/}</title>
<link rel="stylesheet" type="text/css" href="skin/{echo: $SYSINFO['templates'];/}/css/modules.css">
<link rel="stylesheet" type="text/css" href="skin/{echo: $SYSINFO['templates'];/}/css/layout.css">
<style type="text/css">
.red { color:red; }
.edit span{background:#efefef;}
.search {margin:5px;}
.search input {color:#444;}
.clear {clear:both;}
td{text-align:left;}
#bgdiv { background-color:#333; position:absolute; width:980px; left:0px; top:0px; opacity:0.4; filter:alpha(opacity=40); height:1000px; z-index:960}
#category_select { width:800px; z-index:961; position:absolute; filter:alpha(opacity=95); left:100px; top:160px; background-color:#fff; height:270px}
.category_title_1 {background:#FFE1C2; color:#F67A06; padding-left:10px; line-height:25px; font-weight:bold; font-size:14px;}
.category_title_1 span {float:right; padding-right:5px; cursor:pointer;}
.ulselect {width:198px; height:210px; overflow-x:hidden; overflow-y:scroll; border:1px solid #efefef; float:left;}
.ulselect li {line-height:21px; padding-left:5px; cursor:pointer;width:100%;float:left;text-align:left;}
.ulselect li:hover {background:#F6A248; color:#fff;}
.ulselect li.select {background:#F6A248; color:#fff;}
.category_com {height:30px; line-height:30px; text-align:center;}
.attr_class { background:#FFF2E6; }
.attr_class div.div {border:2px solid #fff; padding:3px;}
.attr_class div span.left{display:block; width:150px; float:left; margin-left:10px; text-align:right; _line-height:24px;}
.attr_class div span.right{display:block; width:350px; float:left; margin-left:5px; text-align:left;}
.attr_class div span.right input {margin-left:5px;}

#picspan {width:82px; height:82px; padding:1px; border:1px solid #efefef; line-height:80px; text-align:center; display:inline-block; overflow:hidden; float:right;}
</style>
<script type="text/javascript" src="servtools/nicedit/nicEdit.js"></script>
<script type="text/javascript">
bkLib.onDomLoaded(function() {
	new nicEditor({iconsPath : 'servtools/nicedit/nicEditorIcons.gif'}).panelInstance('goods_intro');
});

function AddContentImg(ImgName,classId){
	var obj = document.getElementById("goods_intro").previousSibling.children[0];
	obj.innerHTML = obj.innerHTML + "<br><IMG src='./"+ImgName+"' /><br>";
}

function checkForm() {
	var goods_name = document.getElementsByName("goods_name")[0];

	if(goods_name.value=='') {
		alert("{echo: lp{m_goodsname_notnone};/}");
		title.focus();
		return false;
	} else if(document.getElementsByName("cat_id")[0].value==0) {
		alert("{echo:  lp{m_select_categorypl};/}");
		return false;
	}
	return true;
}
</script>
</head>
<body onload="bodyonload();">
<div class="container">
	{inc: require("modules/header.php");/}
    <div class="clear"></div>
    <div class="apart">
    	{inc: require("modules/left_menu.php");/}
        <div class="bigpart">
		<div class="title_uc"><h3><span style="float:right; margin-right:15px;"><a href="modules.php?app=goods_list" style="color:#F67A06;">{echo:lp{m_back_list};/}</a>&nbsp;&nbsp;</span>{echo:lp{m_edit_goods};/}</h3></div>
		<form action="do.php?act=goods_edit" method="post" name="form_goods_edit" onsubmit="return checkForm();" enctype="multipart/form-data">
			<table width="98%" class="form_table">
				<tr><td class="textright" >{echo: lp{m_goods_category};/}：</td>
					<td align="left">&nbsp;<span id="show_cat_name">{echo:$select_category_name;/}</span> &nbsp;&nbsp;<a href="javascript:;" onclick="showbgdiv();" style="color:#F1A24C; font-weight:bold;text-decoration:underline;">{echo:lp{m_edit_cateogry};/}</a>
					<input name="cat_id" value="{echo: $goods_info['cat_id'];/}" type="hidden"></td>
				</tr>
				<tr>
					<td class="textright">{echo:lp{m_goods_brand};/}:</td>
					<td align="left" id="brand_box">&nbsp;</td>
				</tr>
				<tr>
					<td class="textright">{echo:lp{m_goods_type};/}：</td>
					<td align="left"><input type="radio" name="type_id" value="1" {sta:if($goods_info['type_id']=='1')[exc]}checked{end:if/} />{echo:lp{m_goods_new};/} &nbsp;&nbsp;
					<input type="radio" name="type_id" value="2" {sta:if($goods_info['type_id']=='2')[exc]}checked{end:if/} />{echo:lp{m_goods_notnew};/} &nbsp;&nbsp;
					<input type="radio" name="type_id" value="3" {sta:if($goods_info['type_id']=='3')[exc]}checked{end:if/} />{echo:lp{m_goods_isnull};/} </span></td>
				</tr>
				<tr id="goods_attr_tr">
					<td class="textright">{echo:lp{m_goods_attr};/}：</td>
					<td align="left" class="attr_class" id="attr_content"></td>
				</tr>
				<tr>
					<td class="textright">{echo: lp{m_goods_name};/}：</td>
					<td align="left"><input type="text" name="goods_name" value="{echo: $goods_info['goods_name'];/}" style="width:395px;" maxlength="200" /> <span class="red">*</span></td>
				</tr>
				<tr><td class="textright">{echo: lp{m_ucategory};/}：</td>
					<td align="left"><select name="ucat_id">
						<option value="0">{echo:lp{m_select_cateogry};/}</option>
						{echo: $html_shop_category;/}
					</select> <span class="red">*</span>
					<span id="ucate_add"><a href="javascript:;" onclick="showinput();">{echo:  lp{m_add_cat};/}</a></span>
					<span id="ucate_span" style="display:none;"><input type="text" value="" style="width:115px;" id="ucat_input" /><input type="button" value="{echo:  lp{m_add};/}" onclick="addnewucat();" /></span></td>
				</tr>
				<tr>
					<td class="textright">{echo:  lp{m_goods_price};/}：</td>
					<td align="left"><input type="type" name="goods_price" value="{echo:  $goods_info['goods_price'];/}" style="width:80px;
						text-align:right;" maxlength="8" /> {echo:  lp{m_yuan};/} ({echo:  lp{m_goods_pricezero};/})</td></tr>
				<tr>
					<td class="textright">
						<input type="radio" value="1" id="is_transport_template" onclick="chostransporttype(1)" {sta:if($goods_info['is_transport_template'])[exc]} checked  {end:if/}   name="is_transport_template" /> {echo:lp{m_is_transport_template};/}</td>
					<td align="left">
					{sta:if(is_array($transport_template_list))[exc]}
						{sta:foreach($transport_template_list as $value)[loop]}
							<input type="radio" name="transport_template_id" onclick="chostransporttype(1)"  value="{echo:$value['id'];/}" {sta:if($goods_info['transport_template_id']==$value['id'])[exc]} checked {end:if/} />{echo:$value['transport_name'];/}&nbsp;<a href="modules.php?app=edit_transport_template&id={echo:$value['id'];/}" target="_blank">{echo: lp{m_eidt_transport_template};/}</a><br />
						{end:foreach/}
					{end:if/}
					<br />
					<a href="modules.php?app=add_transport_template" target="_blank">{echo: lp{m_add_transport_template};/}</a>
					</td>
				</tr>
				<tr>
					<td class="textright"><input type="radio"  onclick="chostransporttype(0)" value="0" {sta:if(!$goods_info['is_transport_template'])[exc]} checked  {end:if/}   name="is_transport_template" />{echo:  lp{m_transport_price};/}：</td>
					<td align="left"><input type="type" name="transport_price" value="{echo:  $goods_info['transport_price'];/}" style="width:80px; text-align:right;" maxlength="8" /> {echo:lp{m_yuan};/}</td>
				</tr>
				<tr><td class="textright"><span id="picspan">{sta:if($goods_info['goods_thumb'])[exc]}<img src="{echo:$goods_info['goods_thumb'];/}" />{sta: }else[exc]}{echo: lp{m_showgoods_photo};/}{end:if/}</span></td><td align="left"><input type="file" name="attach[]" onchange="showimg(this)" />
				<!-- <input type="button" value="使用已上传图片" onclick="get_img_list('img_select1','1','img_list1',this)"> <span class="red">*</span> --><br />
					图片应小于1M，jpg、png或gif格式。建议为{echo:$SYSINFO['height2'];/}</>x{echo:$SYSINFO['width2'];/}像素
					<!-- <div id="img_select1" style="width:600px;  display:none;">
                    	<span id="img_list1">

                    	</span>
					</div> -->
				</td></tr>
				<tr><td align="left" class="textright">{echo: lp{m_goods_intro};/}：</td>
					<td>
				<textarea name="goods_intro" id="goods_intro" cols="75" rows="5">{echo:  $goods_info['goods_intro'];/}</textarea>
				<iframe name="KindImageIframe" id="KindImageIframe" width="100%" height=30 align="top" allowTransparency="true" scrolling="no" src='modules.php?app=upload_form' frameborder=0></iframe>
				<input type="button" value="使用已上传图片" onclick="get_img_list('img_select2','2','img_list2',this)">
					<div id="img_select2" style="width:600px;  display:none;">
                    	<div id="img_list2">

                    	</div>
					</div>
				</td></tr>
				<tr><td class="textright">{echo:  lp{m_wholesale};/}：</td>
					<td align="left">
				<textarea name="goods_wholesale" cols="45" rows="3">{echo:  $goods_info['goods_wholesale'];/}</textarea>
				</td></tr>
				<tr><td class="textright">{echo:  lp{m_goods_number};/}：</td>
					<td align="left"><input type="type" name="goods_number" value="{echo:  $goods_info['goods_number'];/}" style="width:80px; text-align:right;" maxlength="5" /> {echo:  lp{m_jian};/}</td></tr>
				<tr><td class="textright">{echo:  lp{m_keyword};/}：</td>
					<td align="left"><input type="type" name="keyword" value="{echo:  $goods_info['keyword'];/}" style="width:250px;" maxlength="200" /> {echo:lp{m_more_keyword_exp};/}</td></tr>
				<tr><td class="textright">{echo:  lp{m_on_sale};/}：</td>
					<td align="left"><input type="checkbox" name="is_on_sale" value="1" {sta:if($goods_info['is_on_sale']){ echo "checked";if/}/> {echo:  lp{m_view_status};/}</td></tr>
				<tr><td class="textright">{echo:  lp{m_add_recommend};/}：</td>
					<td align="left"><input type="checkbox" name="is_best" value="1" {sta:if($goods_info['is_best']){ echo "checked";if/} />
					{echo:  lp{m_best};/}&nbsp;
					<input type="checkbox" name="is_promote" value="1" {sta:if($goods_info['is_promote']){ echo "checked";if/} />
					{echo: lp{m_promote};/}&nbsp;
					<input type="checkbox" name="is_new" value="1" {sta:if($goods_info['is_new']){ echo "checked";if/} />
					{echo:  lp{m_new};/}&nbsp;
					<input type="checkbox" name="is_hot" value="1" {sta:if($goods_info['is_hot']){ echo "checked";if/} />
					{echo:  lp{m_hot};/}&nbsp;
					{echo: lp{m_set_num};/}{echo:$user_privilege['4'];/}{echo: lp{m_best};/}，{echo:$user_privilege['5'];/}{echo: lp{m_promote};/}，{echo:$user_privilege['6'];/}{echo: lp{m_new};/}，{echo:$user_privilege['7'];/}{echo: lp{m_hot};/}，{echo: lp{m_num_much};/}
				</td></tr>
				<tr><td colspan="2" class="center"><input type="hidden" name="goods_id" value="{echo:  $goods_info['goods_id'];/}" />
				<input type="submit" name="submit" value="{echo: lp{m_edit_goods};/}" /></td></tr>
			</table>
		</form>
        </div>
    </div>
    <div class="clear"></div>
    {inc: require("modules/footer.php");/}
    <div id="bgdiv" style="display:none;"></div>
	<div id="category_select" style="display:none;">
		<div class="category_title_1"><span onclick="hidebgdiv();">{echo:lp{m_close};/}</span>{echo:lp{m_plss_select_cateogry};/}</div>
		{sta:if($isset_payment)[exc]}
		<ul id="select_first" class="ulselect">
			{sta:foreach($category_info as $k=>$v)[loop]}
				{sta:if($v['parent_id']==0)[exc]}
				<li title="{echo: $v['cat_id'];/}">{echo: $v['cat_name'];/}</li>
				{end:if/}
			{end:foreach/}
		</ul>
		<ul id="select_second" class="ulselect"></ul>
		<ul id="select_third" class="ulselect"></ul>
		<ul id="select_fourth" class="ulselect"></ul>
		<div class="category_com"><input type="button" value="{echo:lp{m_post};/}" onclick="postcatid();" /></div>
		{sta: } else [exc]}
		<div align="center">{echo:lp{m_isset_payment};/}</div>
		{end:if/}
	</div>
</div>
<script language="JavaScript" src="servtools/ajax_client/ajax.js"></script>
<script language="JavaScript">
<!--
var attribute = {echo: $js_attribute_info;/};
var goodsAttr = new Array();
{sta:if($goods_attr) {
	foreach($goods_attr as $v) {
		$v['attr_values'] = preg_replace("/[\r\n]+/",'|',$v['attr_values']);
		if(substr($v['attr_values'],'-1') == '|') {
			$v['attr_values'] = substr($v['attr_values'],'0','-1');
		}
		echo "goodsAttr['".$v['attr_id']."'] = '".$v['attr_values']."'; \r\n";
	}
if/}

var select_value = {'first':'','second':'','third':'','fourth':'','value':'0'};

function showbgdiv() {
	var bgdiv = document.getElementById("bgdiv");
	var goods_attr_tr = document.getElementById("goods_attr_tr");
	var category_select = document.getElementById("category_select");
	var ucat_id = document.getElementsByName("ucat_id")[0];
	var brand_box = document.getElementById("brand_box");
	ucat_id.style.display = "none";
	goods_attr_tr.style.display = "none";
	bgdiv.style.display = '';
	brand_box.style.display = 'none';
	category_select.style.display = '';
	var width = document.body.clientWidth;
	var left = "100";
	if(width) {
		left = (width-800)/2;
	}
	category_select.style.left = left+"px";
	bgdiv.style.left = (width-980)/2+"px";
}

function hidebgdiv() {
	var bgdiv = document.getElementById("bgdiv");
	var category_select = document.getElementById("category_select");
	var goods_attr_tr = document.getElementById("goods_attr_tr");
	var ucat_id = document.getElementsByName("ucat_id")[0];
	var brand_box = document.getElementById("brand_box");
	ucat_id.style.display = "";
	bgdiv.style.display = 'none';
	category_select.style.display = 'none';
	brand_box.style.display = '';
	goods_attr_tr.style.display = "";
}

function bodyonload() {
	var cat_id = document.getElementsByName("cat_id")[0];
	if(cat_id.value>0) {
		get_brand_list(cat_id.value)
	} else {
		showbgdiv();
	}


	var lis = document.getElementsByTagName("li");
	for(var i=0; i<lis.length; i++) {
		lis[i].onclick = selectli;
	}
}

function selectli() {
	var tlis = this.parentNode.childNodes;
	for(var j=0; j<tlis.length; j++) {
		tlis[j].className = '';
	}
	this.className = "select";

	var nextul = null;
	if(this.parentNode.id=='select_first') {
		nextul = document.getElementById("select_second");
		select_value.first = this.innerHTML;
		select_value.second = '';
		select_value.third = '';
		select_value.fourth = '';
		nextul.innerHTML = '';
		document.getElementById("select_third").innerHTML = '';
		document.getElementById("select_fourth").innerHTML = '';
	} else if(this.parentNode.id=='select_second') {
		nextul = document.getElementById("select_third");
		select_value.second = ' > '+this.innerHTML;
		select_value.third = '';
		select_value.fourth = '';
		nextul.innerHTML = '';
		document.getElementById("select_fourth").innerHTML = '';
	} else if(this.parentNode.id=='select_third') {
		nextul = document.getElementById("select_fourth");
		select_value.third = ' > '+this.innerHTML;
		select_value.fourth = '';
		nextul.innerHTML = '';
	} else if(this.parentNode.id=='select_fourth'){
		select_value.fourth = ' > '+this.innerHTML;
	}
	select_value.value = this.title;
	if(nextul) {
		var cat_id = this.title;
		ajax("do.php?act=category_get_catlist","POST","cat_id="+cat_id,function(data){
			if(data!='-1') {
				var newli;
				for(var i=0; i<data.length; i++) {
					newli = document.createElement("li");
					newli.onclick = selectli;
					newli.title = data[i].cat_id;
					newli.innerHTML = data[i].cat_name;
					nextul.appendChild(newli);
				}
			}
		},'JSON');
	}
}

function postcatid() {
	var cat_id = document.getElementsByName("cat_id")[0];
	var show_cat_name = document.getElementById("show_cat_name");
	show_cat_name.innerHTML = select_value.first + select_value.second + select_value.third + select_value.fourth;
	cat_id.value = select_value.value;
	changeAttr(select_value.value);
	hidebgdiv();
}

function changeAttr(value) {
	ajax("do.php?act=goods_attr_list","POST","v="+value,function(data){
		changeAttrTr(data);
	},'JSON');
}

function changeAttrTr(objvalue) {
	var attr_content = document.getElementById("attr_content");
	attr_content.innerHTML = '';
	var html = '';
	var temp = '';
	for(var i=0; i<objvalue.length; i++) {
		temp = formatFormElement(objvalue[i].attr_id,objvalue[i].input_type,objvalue[i].attr_name,objvalue[i].attr_values);
		html += '<div class="div"><span class="left">'+objvalue[i].attr_name+'：</span><span class="right">'+temp+'</span><div class="clear"></div></div>';
	}
	attr_content.innerHTML = html;
}

//属性input类型 0:TEXT,1:SELECT,2:radio,3:checkbox
function formatFormElement(id,type,name,value) {
	var optionValue;
	var cValue = str = '';
	if(goodsAttr[id]) {
		cValue = goodsAttr[id];
	}
	if(type==0) {
		str = '<input type="text" name="attr[' + id + ']" value="'+cValue+'" maxlength="200" />';
	} else if (type==1 && value!='') {
		optionValue = value.split("\r\n");
		str = '<select name="attr[' + id + ']">';
		str += '<option value="0">{echo: lp{m_select_pl};/}' + name + '</option>';
		for(var i=0; i<optionValue.length; i++) {
			if(optionValue[i] == cValue) {
				str += '<option value="'+optionValue[i]+'" selected>' + optionValue[i] + '</option>';
			} else {
				str += '<option value="'+optionValue[i]+'">' + optionValue[i] + '</option>';
			}
		}
		str += '</select>';
	} else if (type==2 && value!='') {
		optionValue = value.split("\r\n");
		for(var i=0; i<optionValue.length; i++) {
			if(optionValue[i] == cValue) {
				str += '<input type="radio" name="attr[' + id + ']" value="'+optionValue[i]+'" checked />' + optionValue[i] + ' ';
			} else {
				str += '<input type="radio" name="attr[' + id + ']" value="'+optionValue[i]+'" />' + optionValue[i] + ' ';
			}
		}
	} else if (type==3 && value!='') {
		var regv = cValue.replace(/[\r\n]/g,"|");
		if(regv) {
			var re = new RegExp("(("+regv+")|([^\r\n]+))[\r\n]*","g");
		} else {
			var re = new RegExp("((iwebshop)|([^\r\n]+))[\r\n]*","g");
		}
		var str = value.replace(re,"<input type='checkbox' name='attr[" + id + "][]' value='$1' checked$3 />$1 ");
	}
	return str;
}

changeAttrTr(attribute);

function showimg(obj) {
	var picspan = document.getElementById("picspan");
	picspan.innerHTML = '';
	var Img = new Image();
	Img.id = "goods_pic";

	if(navigator.userAgent.indexOf("MSIE")>0) {
		Img.src = obj.value;
	} else {
		Img.src = obj['files'][0].getAsDataURL();
	}
	picspan.appendChild(Img);
	//imgwh();
	setTimeout("imgwh()",100);
}

function imgwh() {
	var Img = document.getElementById("goods_pic");
	var w = Img.width;
	var h = Img.height
	if(w>h) {
		Img.height = h*80/w;
		Img.width = '80';
		Img.style.marginTop = (80-Img.height)/2+'px';
	} else {
		Img.width = w*80/h;
		Img.height = '80';
	}
}

function showinput() {
	var ucate_add = document.getElementById("ucate_add");
	var ucate_span = document.getElementById("ucate_span");
	ucate_add.style.display = 'none';
	ucate_span.style.display = '';
}
function hideinput() {
	var ucate_add = document.getElementById("ucate_add");
	var ucate_span = document.getElementById("ucate_span");
	ucate_add.style.display = '';
	ucate_span.style.display = 'none';
}

function addnewucat() {
	var ucat_input = document.getElementById("ucat_input");
	var ucat_id = document.getElementsByName("ucat_id")[0];
	v = ucat_input.value;
	if(v=='') {
		alert("{echo: lp{m_categoryname_notnone};/}");
		return false;
	} else {
		ajax("do.php?act=goods_ucategory_add","POST","name="+v,function(data){
			if(data!='-1') {
				var newoption = document.createElement("option");
				newoption.value = data;
				newoption.innerHTML = v;
				newoption.selected = 'selectes';
				ucat_id.appendChild(newoption);
				alert("{echo: lp{m_add_success};/}");
			} else {
				alert("{echo: lp{m_add_fail};/}");
			}
		},'JSON');
		hideinput();
	}
}
function get_brand_list(cat_id_value){
	ajax("do.php?act=get_brand_list&cat_id="+cat_id_value,"POST","",function(data){
		var str="<select name='brand_id'>";
		for(i=0;i<data.length;i++){
			str+="<option value='"+data[i].brand_id+"'";
			if(data[i].brand_id=={echo:$goods_info['brand_id'];/}){
				str+="selected";
			}
			str+=">"+data[i].brand_name+"</option>";
		}
		str+="<option value='0'>其他品牌</option>";
		str+="</select>";
		document.getElementById("brand_box").innerHTML=str;
		document.getElementById("brand_box").style.display='';
	},'JSON');
}
function chostransporttype(m){
	var obj=document.form_goods_edit;
	var radioobj=document.getElementsByName("transport_template_id");
//	alert(radioobj.length);
	if(m==1){
		obj.transport_price.value=0.00;
		document.getElementById("is_transport_template").checked=true;
		var b=0;
		for(i=0;i<radioobj.length;i++){
			if(radioobj[i].checked){
				b++;
			}
		}
		if(b==0){
			radioobj[0].checked=true;
		}
	}else{
		for(i=0;i<radioobj.length;i++){
			radioobj[i].checked=false;
		}
	}
}

function get_img_list(itemid,i,imgid,obj){
	if(document.getElementById(itemid).style.display=='') {
		document.getElementById(itemid).style.display="none";
	} else {
 		document.getElementById(itemid).style.display="";
		ajax("do.php?act=shop_img_select","POST","i="+i,function(data){
			document.getElementById(imgid).innerHTML = data;
		});
	}
}
//-->
</script>
</body>
</html>